<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venatus - Sistema de Administraci√≥n</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Pantalla de Login */
        #loginScreen {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            color: #2A9DF4;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2A9DF4;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #2A9DF4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #1e87d4;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background: #ffeaea;
            border-radius: 5px;
            display: none;
        }

        /* Pantallas Principales */
        #superAdminScreen, #adminScreen {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        /* Bot√≥n de Cerrar Sesi√≥n */
        .logout-btn {
            background: rgba(255,255,255,0.95);
            border: 2px solid #2A9DF4;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            color: #2A9DF4;
        }

        .logout-btn:hover {
            background: #2A9DF4;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* Estilos para el super admin */
        #map {
            height: 100%;
            width: 100%;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 999;
        }

        #posicion {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 999;
            text-align: center;
        }

        /* Estilos para mostrar perros en la lista de socios */
        .perro-mini-item {
            background: #f8f9fa;
            border-left: 3px solid #ff6b35;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .perro-con-ubicacion {
            color: #28a745;
            font-weight: bold;
        }

        .perro-sin-ubicacion {
            color: #6c757d;
        }

        /* Panel de gesti√≥n de perros */
        #perrosPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.98);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
        }

        .perro-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .perro-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .perro-info p {
            margin: 2px 0;
            font-size: 12px;
            color: #666;
        }

        .perro-ubicacion {
            font-size: 11px;
            color: #2A9DF4;
            background: #e8f4fe;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
        }

        .perro-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-asignar {
            background: #2A9DF4;
            color: white;
        }

        .btn-ubicacion {
            background: #28a745;
            color: white;
        }

        .btn-editar-perro {
            background: #ffc107;
            color: black;
        }

        .btn-eliminar-perro {
            background: #dc3545;
            color: white;
        }

        .status-activo {
            color: #28a745;
            font-weight: bold;
        }

        .status-inactivo {
            color: #dc3545;
            font-weight: bold;
        }

        /* Formulario de perros */
        .perro-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .perro-form input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .coordenadas-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        #listaPerros {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }

        /* Panel de monitoreo de perros */
        #monitoreoPerrosPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 350px;
            max-height: 500px;
            display: none;
            overflow-y: auto;
        }

        .perro-monitoreo-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
        }

        .perro-marcador {
            background: #ff6b35 !important;
            border: 2px solid #fff !important;
        }

        /* Indicador de modo edici√≥n */
        #modoEdicion {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,193,7,0.95);
            color: #856404;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 999;
            display: none;
        }

        /* Bot√≥n Finalizar Edici√≥n */
        #btnFinalizarEdicion {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            transition: all 0.3s ease;
        }

        #btnFinalizarEdicion:hover {
            background: #218838;
            transform: translateX(-50%) scale(1.05);
        }

        #menu {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }

        #menuToggle {
            background: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.1);
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #333;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        #menuToggle:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        #menuItems {
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
            transform-origin: top;
        }

        #menuItems button, #menuItems select {
            display: block;
            width: 200px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #333;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 5px;
        }

        #menuItems button:hover {
            background: rgba(0,0,0,0.05);
            transform: translateX(5px);
        }

        /* Controles de zoom */
        #zoomControls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        #zoomControls button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.9);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #zoomControls button:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        /* Panel de registro de socios */
        #registroPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.98);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
        }

        /* Panel de monitoreo de socios */
        #monitoreoPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            display: none;
            overflow-y: auto;
        }

        /* Panel de Gesti√≥n de Administradores */
        #adminPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.98);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
        }

        /* Panel de Modificaci√≥n de Cotos */
        #modificarPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.98);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
        }

        #modificarPanel h3 {
            margin-top: 0;
            color: #2A9DF4;
            margin-bottom: 15px;
        }

        #modificarPanel select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        #modificarPanel button {
            width: 100%;
            padding: 12px;
            background: #2A9DF4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        #modificarPanel button:hover {
            background: #1e87d4;
        }

        #btnGuardarCambios {
            background: #28a745 !important;
        }

        #btnGuardarCambios:hover {
            background: #218838 !important;
        }

        #btnCancelarModificacion {
            background: #6c757d !important;
        }

        #btnCancelarModificacion:hover {
            background: #5a6268 !important;
        }

        #mensajeModificacion {
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        /* Items de administrador en la lista */
        .admin-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .admin-info p {
            margin: 2px 0;
            font-size: 12px;
            color: #666;
        }

        .admin-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }

        .btn-activar {
            background: #28a745;
            color: white;
        }

        .btn-desactivar {
            background: #dc3545;
            color: white;
        }

        .btn-editar {
            background: #ffc107;
            color: black;
        }

        .status-activo {
            color: #28a745;
            font-weight: bold;
        }

        .status-inactivo {
            color: #dc3545;
            font-weight: bold;
        }

        #registroPanel h3, #monitoreoPanel h3 {
            margin-top: 0;
            color: #2A9DF4;
        }

        #registroPanel input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        #registroPanel button, #monitoreoPanel button {
            width: 100%;
            padding: 12px;
            background: #2A9DF4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        #registroPanel button:hover {
            background: #1e87d4;
        }

        #btnIniciarMonitoreo {
            background: #28a745 !important;
        }

        #btnIniciarMonitoreo:hover {
            background: #218838 !important;
        }

        #btnDetenerMonitoreo {
            background: #dc3545 !important;
        }

        #btnDetenerMonitoreo:hover {
            background: #c82333 !important;
        }

        #listaSocios {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
        }

        #cotoActual {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        #estadoMonitoreo {
            margin-top: 10px;
            font-size: 11px;
            text-align: center;
            color: #666;
        }

        /* Separador visual en el men√∫ */
        .menu-separator {
            height: 1px;
            background: rgba(0,0,0,0.1);
            margin: 5px 0;
        }

        /* === ESTILOS ADMIN COTO === */
        #adminMap {
            height: 100%;
            width: 100%;
        }

        /* Panel de control Admin Coto */
        #controlPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .header-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #2A9DF4;
        }

        .coto-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2A9DF4;
            margin-bottom: 5px;
        }

        .admin-name {
            color: #666;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #2A9DF4;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        #sociosList {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .socio-item {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
        }

        .socio-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .socio-coords {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .socio-status {
            font-size: 0.8em;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .status-dentro {
            background: #d4edda;
            color: #155724;
        }

        .status-fuera {
            background: #f8d7da;
            color: #721c24;
        }

        .controls {
            margin-top: 15px;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        #statusMessage {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        #adminLogoutBtn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 9999;
        }

        /* Overlay para fondo oscuro */
        #adminOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        /* ESTILOS ESPEC√çFICOS PARA EL SELECT DE SOCIOS */
        #perroSocio {
            width: 100% !important;
            padding: 10px 12px !important;
            margin: 10px 0 !important;
            border: 2px solid #ddd !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            background-color: white !important;
            color: #333 !important;
            cursor: pointer !important;
            box-sizing: border-box !important;
            display: block !important;
            z-index: 1001 !important;
            position: relative !important;
        }

        #perroSocio option {
            padding: 10px !important;
            background-color: white !important;
            color: #333 !important;
        }

        #perroSocio:focus {
            outline: none !important;
            border-color: #2A9DF4 !important;
            box-shadow: 0 0 0 3px rgba(42, 157, 244, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen">
        <div class="logo">üåø Venatus</div>
        <div class="subtitle">Sistema de Administraci√≥n</div>
        
        <div class="input-group">
            <label for="adminUsuario">Usuario:</label>
            <input type="text" id="adminUsuario" placeholder="Ingresa tu usuario">
        </div>
        
        <div class="input-group">
            <label for="adminPassword">Contrase√±a:</label>
            <input type="password" id="adminPassword" placeholder="Ingresa tu contrase√±a">
        </div>
        
        <button class="btn" onclick="login()">Acceder al Sistema</button>
        
        <div id="loginError" class="error-message"></div>
    </div>

    <!-- Pantalla Super Administrador -->
    <div id="superAdminScreen">
        
        <div id="info"></div>
        <div id="posicion">Posici√≥n actual: ---, ---</div>
        <div id="modoEdicion">‚úèÔ∏è MODO EDICI√ìN - Puedes modificar el coto en el mapa</div>
        <div id="map"></div>

        <!-- Bot√≥n Finalizar Edici√≥n -->
        <button id="btnFinalizarEdicion">‚úÖ Finalizar Edici√≥n</button>

        <!-- Panel de Gesti√≥n de Perros -->
        <div id="perrosPanel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2A9DF4;">üêï Gesti√≥n de Perros de Caza</h3>
                <button onclick="cerrarPanelPerros()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">√ó</button>
            </div>

            <!-- Formulario para crear/editar perro -->
            <div class="perro-form">
                <h4 style="margin-top: 0; color: #333;" id="tituloFormPerro">‚ûï Nuevo Perro de Caza</h4>
                
                <input type="text" id="perroNombre" placeholder="Nombre del perro (m√°x 30 caracteres)" maxlength="30">
                <input type="text" id="perroIdentificador" placeholder="Identificador √∫nico (m√°x 50 caracteres)" maxlength="50">
                
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Socio Propietario (opcional)</label>
                    <select id="perroSocio">
                        <option value="">-- Sin asignar --</option>
                        <!-- Los socios se cargar√°n aqu√≠ din√°micamente -->
                    </select>
                </div>
                
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Ubicaci√≥n Inicial (opcional)</label>
                    <div class="coordenadas-input">
                        <input type="number" id="perroPosX" placeholder="Coordenada X (longitud)" step="any">
                        <input type="number" id="perroPosY" placeholder="Coordenada Y (latitud)" step="any">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="usarUbicacionActualPerro()" style="flex: 1; padding: 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üìç Usar mi ubicaci√≥n
                        </button>
                        <button onclick="limpiarCoordenadasPerro()" style="flex: 1; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>

                <button id="btnAccionPerro" onclick="guardarPerro()" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ‚úÖ Registrar Perro
                </button>
                
                <div id="mensajePerro" style="margin-top: 10px; font-size: 12px; text-align: center;"></div>
            </div>

            <!-- Lista de perros existentes -->
            <div>
                <h4 style="margin-bottom: 10px; color: #333;">üìã Perros Registrados</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="cargarPerros()" style="flex: 1; padding: 8px; background: #2A9DF4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üîÑ Actualizar Lista
                    </button>
                    <button onclick="iniciarMonitoreoPerros()" style="flex: 1; padding: 8px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üéØ Monitorear Perros
                    </button>
                </div>
                
                <div id="listaPerros" style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Cargando perros...
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Monitoreo de Perros -->
        <div id="monitoreoPerrosPanel">
            <div style="position: relative; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #ff6b35; padding-right: 30px;">üêï Monitoreo de Perros</h3>
                <button onclick="cerrarMonitoreoPerros()" style="position: absolute; top: -8px; right: 2px; background: none; border: none; font-size: 22px; cursor: pointer; color: #666; padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.2);">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Estado:</label>
                <div id="estadoMonitoreoPerros" style="background: #f5f5f5; padding: 8px; border-radius: 6px; font-size: 14px;">
                    Monitoreo inactivo
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="iniciarMonitoreoPerros()" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ‚ñ∂Ô∏è Iniciar
                </button>
                <button onclick="detenerMonitoreoPerros()" style="flex: 1; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: none;">
                    ‚èπÔ∏è Detener
                </button>
            </div>
            
            <div style="margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px;">Perros Activos:</h4>
                <div id="listaPerrosMonitoreo">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        No hay perros en monitoreo
                    </div>
                </div>
            </div>
            
            <div id="contadorPerros" style="margin-top: 10px; font-size: 12px; text-align: center; color: #666;"></div>
        </div>

        <!-- Panel de registro de socios -->
        <div id="registroPanel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #2A9DF4;">Registrar Nuevo Socio</h3>
                <button onclick="cerrarPanelRegistro()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">√ó</button>
            </div>
            
            <!-- Campos existentes + DNI -->
            <input type="text" id="regNombre" placeholder="Nombre completo" maxlength="50">
            <input type="text" id="regDNI" placeholder="DNI (documento de identidad)" maxlength="20"> <!-- NUEVO CAMPO -->
            <input type="text" id="regUsuario" placeholder="Usuario" maxlength="20">
            <input type="password" id="regContrasena" placeholder="Contrase√±a" maxlength="20">
            <input type="email" id="regEmail" placeholder="Email" maxlength="100">
            <input type="text" id="regTelefono" placeholder="Tel√©fono (9 d√≠gitos)" maxlength="9">
            
            <button id="btnRegistrarSocio">Registrar Socio</button>
            <div id="mensajeRegistro" style="margin-top: 10px; font-size: 14px;"></div>
        </div>

        <!-- En la secci√≥n del panel de monitoreo de socios -->
        <div id="monitoreoPanel" style="display: none;">
            <!-- Cabecera con t√≠tulo y bot√≥n cerrar posicionado arriba a la derecha -->
            <div style="position: relative; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #2A9DF4; padding-right: 30px;">üë• Monitorear Socios</h3>
                <button onclick="cerrarPanelMonitoreo()" style="position: absolute; top: -8px; right: 2px; background: none; border: none; font-size: 22px; cursor: pointer; color: #666; padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.2);">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Coto Seleccionado:</label>
                <div id="cotoActual">Ning√∫n coto seleccionado</div>
            </div>
            
            <button id="btnIniciarMonitoreo">‚ñ∂Ô∏è Iniciar Monitoreo</button>
            <button id="btnDetenerMonitoreo" style="display: none;">‚èπÔ∏è Detener Monitoreo</button>
            
            <div style="margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px;">Socios en el Coto:</h4>
                <div id="listaSocios">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Monitoreo no activo
                    </div>
                </div>
            </div>
            
            <div id="estadoMonitoreo"></div>
        </div>

        <!-- Panel de Gesti√≥n de Administradores -->
        <div id="adminPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #2A9DF4;">üëë Gesti√≥n de Administradores</h3>
            <button onclick="cerrarPanelAdmin()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">√ó</button>
        </div>

            <!-- Formulario para crear nuevo administrador -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-top: 0; color: #333;">‚ûï Crear Nuevo Administrador</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Nombre Completo</label>
                        <input type="text" id="adminNombre" placeholder="Ej: Juan P√©rez" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Usuario</label>
                        <input type="text" id="adminUsuarioPanel" placeholder="Ej: juan.admin" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Contrase√±a</label>
                        <input type="password" id="adminClave" placeholder="M√≠nimo 6 caracteres" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Email</label>
                        <input type="email" id="adminEmail" placeholder="Ej: juan@email.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Tipo de Administrador</label>
                    <select id="adminTipo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="admin">Administrador de Coto</option>
                        <option value="superadmin">Super Administrador</option>
                    </select>
                </div>

                <div id="cotoSelection" style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Coto Asignado</label>
                    <select id="adminCoto" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- Selecciona un coto --</option>
                    </select>
                </div>

                <button id="btnAccionAdmin" onclick="crearAdministrador()" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ‚úÖ A√±adir Administrador
                </button>
                
                <div id="mensajeAdmin" style="margin-top: 10px; font-size: 12px; text-align: center;"></div>
            </div>

            <!-- Lista de administradores existentes -->
            <div>
                <h4 style="margin-bottom: 10px; color: #333;">üìã Administradores Existentes</h4>
                <div id="listaAdmins" style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Cargando administradores...
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Modificaci√≥n de Cotos -->
        <div id="modificarPanel">
            <h3>‚úèÔ∏è Modificar Coto</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Selecciona el coto a modificar:</label>
                <select id="selectCotoModificar">
                    <option value="">-- Selecciona un coto --</option>
                </select>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-top: 0; color: #333;">üìù Instrucciones:</h4>
                <ul style="font-size: 14px; margin: 0; padding-left: 20px;">
                    <li>Selecciona un coto para cargarlo en el mapa</li>
                    <li>Haz clic en "Editar Coto" para comenzar la edici√≥n</li>
                    <li>Puedes mover los puntos existentes arrastr√°ndolos</li>
                    <li>Haz clic en una l√≠nea para a√±adir un nuevo punto</li>
                    <li>Haz clic en un punto y presiona "Eliminar" para quitarlo</li>
                    <li>Usa "Finalizar Edici√≥n" cuando termines de modificar</li>
                    <li>Guarda los cambios definitivamente</li>
                </ul>
            </div>
            
            <button id="btnCargarCoto">üó∫Ô∏è Cargar Coto</button>
            <button id="btnEditarCoto" style="display: none; background: #ffc107; color: black;">‚úèÔ∏è Editar Coto</button>
            <button id="btnGuardarCambios" style="display: none;">üíæ Guardar Cambios</button>
            <button id="btnCancelarModificacion">‚ùå Cancelar</button>
            
            <div id="mensajeModificacion"></div>
        </div>

        <div id="menu">
            <button id="menuToggle">&#9776;</button>
            <div id="menuItems">
                <button id="drawPolygon">Delimitar coto</button>
                <button id="deletePolygon">Borrar coto</button>
                <select id="selectArea">
                    <option value="">-- Selecciona un coto --</option>
                </select>
                <button id="saveToDB">Guardar coto</button>
                
                <!-- Separador y nuevas opciones -->
                <div class="menu-separator"></div>
                <button id="registrarSocio">üë§ Registrar Socio</button>
                <button id="monitorearSocios">üë• Monitorear Socios</button>
                
                <!-- NUEVA OPCI√ìN PARA MODIFICAR COTOS -->
                <div class="menu-separator"></div>
                <button id="modificarCoto">‚úèÔ∏è Modificar Coto</button>

                <button id="gestionarPerros">üêï Gestionar Perros</button>
                
                <!-- Gesti√≥n de administradores -->
                <div class="menu-separator"></div>
                <button id="gestionarAdmins">üëë Gestionar Administradores</button>
                
                <!-- Bot√≥n de cerrar sesi√≥n -->
                <div class="menu-separator"></div>
                <button id="logoutSuperAdmin" class="logout-btn" style="width: 100%; text-align: left; margin: 0;">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Controles de zoom -->
        <div id="zoomControls">
            <button id="zoomIn">+</button>
            <button id="zoomOut">-</button>
        </div>

        <!-- Overlay para fondo oscuro -->
        <div id="adminOverlay"></div>
    </div>

    <!-- Pantalla Administrador de Coto -->
    <div id="adminScreen">
        <!-- Bot√≥n de cerrar sesi√≥n en la esquina superior izquierda -->
        <button id="adminLogoutBtn" class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        
        <div id="adminMap"></div>

        <div id="zoomControls">
        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
        </div>
        
        <div id="controlPanel">
            <div class="header-info">
                <div class="coto-name" id="currentCotoName">Coto Actual</div>
                <div class="admin-name" id="currentAdminName">Administrador</div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalSocios">0</div>
                    <div class="stat-label">Total Socios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sociosEnCoto">0</div>
                    <div class="stat-label">En el Coto</div>
                </div>
            </div>
            
            <h4>üë• Socios Monitoreados</h4>
            <div id="sociosList">
                <div style="text-align: center; color: #666; padding: 20px;">
                    Cargando socios...
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="btnIniciarMonitoreoAdmin">‚ñ∂Ô∏è Iniciar Monitoreo</button>
                <button class="btn btn-danger" id="btnDetenerMonitoreoAdmin" style="display: none;">‚èπÔ∏è Detener Monitoreo</button>
            </div>
            
            <div id="statusMessage" class="status-offline">
                Monitoreo inactivo
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script>
        // Variables globales
        let currentUser = null;
        let userType = null;

        // Funci√≥n para cerrar el panel de monitoreo
        function cerrarPanelMonitoreo() {
            document.getElementById('monitoreoPanel').style.display = 'none';
            // Detener el monitoreo si est√° activo
            if (window.intervaloMonitoreo) {
                window.detenerMonitoreo();
            }
        }

        // Funci√≥n para cerrar el panel de registro de socios
        function cerrarPanelRegistro() {
            document.getElementById('registroPanel').style.display = 'none';
        }

        // Funci√≥n para cerrar el panel de administradores
        function cerrarPanelAdmin() {
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // ========== FUNCIONALIDAD DE LOGIN ==========

        async function login() {
            const usuario = document.getElementById('adminUsuario').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!usuario || !password) {
                errorDiv.textContent = 'Usuario y contrase√±a son obligatorios';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/admin/login-unificado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Login exitoso
                    currentUser = data.admin;
                    userType = data.tipo;
                    
                    // Ocultar login
                    document.getElementById('loginScreen').style.display = 'none';
                    
                    // Mostrar la pantalla correspondiente
                    if (userType === 'superadmin') {
                        document.getElementById('superAdminScreen').style.display = 'block';
                        inicializarSuperAdmin();
                    } else {
                        document.getElementById('adminScreen').style.display = 'block';
                        inicializarAdminCoto(data.coto);
                    }
                    
                } else {
                    errorDiv.textContent = data.error || 'Error en el login';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi√≥n con el servidor';
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            // Limpiar todo
            currentUser = null;
            userType = null;
            
            // Ocultar todas las pantallas
            document.getElementById('superAdminScreen').style.display = 'none';
            document.getElementById('adminScreen').style.display = 'none';
            
            // Mostrar login
            document.getElementById('loginScreen').style.display = 'block';
            
            // Limpiar campos
            document.getElementById('adminUsuario').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            
            // Limpiar mapas si existen
            if (window.superAdminMap) {
                window.superAdminMap.remove();
                window.superAdminMap = null;
            }
            if (window.adminMap) {
                window.adminMap.remove();
                window.adminMap = null;
            }
        }

        // Enter para login
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // ========== FUNCIONALIDAD SUPER ADMINISTRADOR ==========

        // Funci√≥n para cerrar el panel de monitoreo
        function cerrarPanelMonitoreo() {
            document.getElementById('monitoreoPanel').style.display = 'none';
            // Detener el monitoreo si est√° activo
            if (typeof detenerMonitoreo === 'function') {
                detenerMonitoreo();
            }
        }

        function inicializarSuperAdmin() {
            // Inicializar mapa
            window.superAdminMap = L.map("map").setView([37.8916, -4.7794], 13);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 22,
                detectRetina: true,
                attribution: "¬© OpenStreetMap contributors"
            }).addTo(window.superAdminMap);

            let drawnItems = new L.FeatureGroup();
            window.superAdminMap.addLayer(drawnItems);

            let drawControl = new L.Control.Draw({
                draw: { polygon: true, polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false },
                edit: { featureGroup: drawnItems, remove: true }
            });

            let lastCoords = [];
            let userMarker = null;
            let polygonActual = null;
            let centrado = false;

            // Variables para monitoreo
            window.intervaloMonitoreo = null;
            window.marcadoresSocios = {};
            let cotoSeleccionadoId = null;

            // Variables para administradores
            let listaAdministradores = [];

            // Variables para modificaci√≥n de cotos
            let cotoEnEdicion = null;
            let editPolygon = null;
            let editLayer = null;
            let modoEdicionActivo = false;

            // Variables para gesti√≥n de perros
            let listaPerros = [];
            let marcadoresPerros = new Map();
            let intervaloMonitoreoPerros = null;
            let modoEdicionPerro = false;
            let perroEditandoId = null;

            // Mostrar/ocultar selecci√≥n de coto seg√∫n tipo de admin
            document.getElementById('adminTipo').addEventListener('change', function() {
                const cotoSelection = document.getElementById('cotoSelection');
                if (this.value === 'admin') {
                    cotoSelection.style.display = 'block';
                } else {
                    cotoSelection.style.display = 'none';
                }
            });

            function puntoDentroPoligono(lat, lng, polyLatLngs) {
                let x = lng, y = lat, inside = false;
                for (let i = 0, j = polyLatLngs.length - 1; i < polyLatLngs.length; j = i++) {
                    let xi = polyLatLngs[i].lng, yi = polyLatLngs[i].lat;
                    let xj = polyLatLngs[j].lng, yj = polyLatLngs[j].lat;
                    let intersect = yi > y !== yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
                    if (intersect) inside = !inside;
                }
                return inside;
            }

            function actualizarPosicion(lat, lng) {
                const posicionDiv = document.getElementById("posicion");
                if (!polygonActual) return;

                if (puntoDentroPoligono(lat, lng, polygonActual.getLatLngs()[0])) {
                    if (userMarker) userMarker.setLatLng([lat, lng]);
                    else userMarker = L.marker([lat, lng], { title: "Tu ubicaci√≥n actual" }).addTo(window.superAdminMap);
                    posicionDiv.style.display = "block";
                    posicionDiv.textContent = `Posici√≥n actual: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                    if (!centrado) {
                        window.superAdminMap.setView([lat, lng], 17);
                        centrado = true;
                    }
                } else {
                    if (userMarker) { window.superAdminMap.removeLayer(userMarker); userMarker = null; }
                    posicionDiv.style.display = "none";
                }
            }

            function iniciarUbicacion() {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        pos => {
                            const { latitude, longitude } = pos.coords;
                            actualizarPosicion(latitude, longitude);
                        },
                        err => console.error("Error obteniendo la ubicaci√≥n:", err),
                        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                    );
                } else {
                    alert("La geolocalizaci√≥n no est√° soportada en este dispositivo.");
                }
            }

            // Iniciar ubicaci√≥n cuando se carga la pantalla
            iniciarUbicacion();

            window.superAdminMap.on(L.Draw.Event.CREATED, e => {
                let layer = e.layer;
                drawnItems.clearLayers();
                drawnItems.addLayer(layer);
                polygonActual = layer;
                calcularArea(layer);
                guardarCoordenadas(layer);
            });

            window.superAdminMap.on('draw:edited', e => {
                e.layers.eachLayer(layer => {
                    polygonActual = layer;
                    guardarCoordenadas(layer);
                    calcularArea(layer);
                });
            });

            window.superAdminMap.on(L.Draw.Event.DELETED, () => {
                polygonActual = null;
                if (userMarker) { window.superAdminMap.removeLayer(userMarker); userMarker = null; }
                const posicionDiv = document.getElementById("posicion");
                posicionDiv.style.display = "none";
                posicionDiv.textContent = "Posici√≥n actual: ---, ---";
            });

            function calcularArea(layer) {
                let latlngs = layer.getLatLngs()[0];
                let area = L.GeometryUtil ? L.GeometryUtil.geodesicArea(latlngs) : 0;
                let areaKm2 = (area / 1_000_000).toFixed(3);
                document.getElementById("info").textContent = `Coto: ${area.toFixed(2)} m¬≤ (${areaKm2} km¬≤)`;
            }

            function guardarCoordenadas(layer) {
                lastCoords = layer.getLatLngs()[0].map(p => ({ lat: p.lat, lng: p.lng }));
            }

            // --- Men√∫ ---
            const menuToggle = document.getElementById("menuToggle");
            const menuItems = document.getElementById("menuItems");
            menuToggle.addEventListener("click", () => {
                menuItems.style.display = menuItems.style.display === "block" ? "none" : "block";
            });

            // Funci√≥n para cerrar el men√∫ autom√°ticamente
            function cerrarMenu() {
                menuItems.style.display = "none";
            }

            // Ocultar panel de monitoreo al iniciar
            document.getElementById('monitoreoPanel').style.display = 'none';

            // Event listener para el bot√≥n de cerrar sesi√≥n dentro del men√∫
            document.getElementById("logoutSuperAdmin").addEventListener("click", function() {
                cerrarMenu();
                logout();
            });

            document.getElementById("zoomIn").addEventListener("click", () => window.superAdminMap.zoomIn());
            document.getElementById("zoomOut").addEventListener("click", () => window.superAdminMap.zoomOut());

            document.getElementById("drawPolygon").addEventListener("click", () => {
                const drawPolygon = new L.Draw.Polygon(window.superAdminMap, drawControl.options.draw.polygon);
                drawPolygon.enable();
                cerrarMenu();
            });

            document.getElementById("deletePolygon").addEventListener("click", () => {
                drawnItems.clearLayers();
                polygonActual = null;
                if (userMarker) { window.superAdminMap.removeLayer(userMarker); userMarker = null; }
                document.getElementById("posicion").style.display = "none";
                document.getElementById("posicion").textContent = "Posici√≥n actual: ---, ---";
                cerrarMenu();
            });

            async function guardarEnFirebird() {
                if (lastCoords.length === 0) {
                    alert("No hay coordenadas para guardar.");
                    return;
                }

                const nombre = prompt("Introduce un nombre para el √°rea:", "√Årea 1") || "√Årea sin nombre";

                try {
                    const respuesta = await fetch("/guardar", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nombre, coordenadas: lastCoords })
                    });

                    const data = await respuesta.json();
                    alert(data.mensaje || "Error al guardar el √°rea.");
                    cargarAreas(); // actualizar lista de √°reas
                } catch (error) {
                    console.error("Error al guardar:", error);
                    alert("Error de conexi√≥n al servidor");
                }
            }

            document.getElementById("saveToDB").addEventListener("click", () => {
                guardarEnFirebird();
                cerrarMenu();
            });

            async function cargarAreas() {
                try {
                    console.log("üîÑ Cargando √°reas...");
                    const res = await fetch("/areas");
                    if (!res.ok) {
                        throw new Error(`Error HTTP: ${res.status}`);
                    }
                    const areas = await res.json();
                    console.log("‚úÖ √Åreas recibidas:", areas);

                    const select = document.getElementById("selectArea");
                    select.innerHTML = '<option value="">-- Selecciona un coto --</option>';

                    areas.forEach(area => {
                        const option = document.createElement("option");
                        option.value = area.id;
                        option.textContent = area.nombre;
                        select.appendChild(option);
                    });

                    console.log(`üìã ${areas.length} √°reas cargadas en el select`);
                } catch (err) {
                    console.error("‚ùå Error cargando √°reas:", err);
                    alert("Error al cargar las √°reas: " + err.message);
                }
            }

            // Cargar √°reas al iniciar
            cargarAreas();

            document.getElementById("selectArea").addEventListener("change", async function() {
                cerrarMenu();
                const selectedId = this.value;
                if (!selectedId) {
                    drawnItems.clearLayers();
                    polygonActual = null;
                    cotoSeleccionadoId = null;
                    document.getElementById('cotoActual').textContent = 'Ning√∫n coto seleccionado';
                    detenerMonitoreo();
                    return;
                }

                try {
                    console.log("üîÑ Solicitando √°rea ID:", selectedId);
                    const res = await fetch(`/areas/${selectedId}`);
                    
                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error("‚ùå Error HTTP:", res.status, errorText);
                        alert("Error al cargar el √°rea: " + errorText);
                        return;
                    }
                    
                    const area = await res.json();
                    console.log("üìå √Årea recibida:", area);

                    if (!area.coords || area.coords.length === 0) {
                        console.warn("‚ö†Ô∏è No hay coordenadas en esta √°rea:", area);
                        alert("Esta √°rea no tiene coordenadas definidas");
                        return;
                    }

                    console.log("üìç Coordenadas a dibujar:", area.coords);
                    
                    drawnItems.clearLayers();
                    const polygon = L.polygon(area.coords, { 
                        color: "#2A9DF4", 
                        weight: 2,
                        fillOpacity: 0.3 
                    }).addTo(drawnItems);
                    
                    window.superAdminMap.fitBounds(polygon.getBounds());
                    polygonActual = polygon;
                    calcularArea(polygon);
                    guardarCoordenadas(polygon);
                    centrado = false;
                    
                    // Configurar monitoreo para este coto
                    cotoSeleccionadoId = selectedId;
                    document.getElementById('cotoActual').textContent = area.nombre;
                    
                    // Solo actualizar el texto del coto actual, no mostrar el panel
                    console.log("‚úÖ √Årea cargada correctamente - Monitoreo listo pero no activo");
                    
                } catch (err) {
                    console.error("‚ùå Error cargando √°rea:", err);
                    alert("Error al cargar el √°rea: " + err.message);
                }
            });

            // ========== FUNCIONALIDAD DE REGISTRO DE SOCIOS ==========
            
            document.getElementById('registrarSocio').addEventListener('click', function() {
                const panel = document.getElementById('registroPanel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
                menuItems.style.display = 'none';
                cerrarMenu();
            });

            // En la funci√≥n de registro de socios, actualizar:
            document.getElementById('btnRegistrarSocio').addEventListener('click', async function() {
                const nombre = document.getElementById('regNombre').value.trim();
                const dni = document.getElementById('regDNI').value.trim(); // NUEVA VARIABLE
                const usuario = document.getElementById('regUsuario').value.trim();
                const contrasena = document.getElementById('regContrasena').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const telefono = document.getElementById('regTelefono').value.trim();

                const mensajeDiv = document.getElementById('mensajeRegistro');

                // Validaciones - Incluir DNI
                if (!nombre || !dni || !usuario || !contrasena || !email || !telefono) {
                    mensajeDiv.innerHTML = '<span style="color: red;">Todos los campos son obligatorios</span>';
                    return;
                }

                if (telefono.length !== 9 || !/^\d+$/.test(telefono)) {
                    mensajeDiv.innerHTML = '<span style="color: red;">El tel√©fono debe tener 9 d√≠gitos</span>';
                    return;
                }

                try {
                    const respuesta = await fetch('/registrar-socio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            nombre, 
                            dni,  // A√ëADIR DNI
                            usuario, 
                            contrasena, 
                            email, 
                            telefono 
                        })
                    });

                    const data = await respuesta.json();

                    if (respuesta.ok) {
                        mensajeDiv.innerHTML = '<span style="color: green;">‚úÖ ' + data.mensaje + '</span>';
                        
                        // Limpiar todos los campos
                        document.getElementById('regNombre').value = '';
                        document.getElementById('regDNI').value = ''; // LIMPIAR DNI
                        document.getElementById('regUsuario').value = '';
                        document.getElementById('regContrasena').value = '';
                        document.getElementById('regEmail').value = '';
                        document.getElementById('regTelefono').value = '';
                        
                        setTimeout(() => {
                            document.getElementById('registroPanel').style.display = 'none';
                            mensajeDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        mensajeDiv.innerHTML = '<span style="color: red;">‚ùå ' + data.error + '</span>';
                    }
                } catch (error) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n con el servidor</span>';
                    console.error('Error:', error);
                }
            });

            // ========== FUNCIONALIDAD DE MONITOREO DE SOCIOS ==========

            document.getElementById('monitorearSocios').addEventListener('click', function() {
                const panel = document.getElementById('monitoreoPanel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
                menuItems.style.display = 'none';
                cerrarMenu();
            });

            // Funci√≥n para actualizar la lista de socios
            async function actualizarSociosEnCoto() {
                if (!cotoSeleccionadoId) {
                    console.log("‚ùå No hay coto seleccionado para monitorear");
                    return;
                }
                
                try {
                    const response = await fetch(`/monitoreo/coto/${cotoSeleccionadoId}/socios`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        actualizarListaSocios(data.socios);
                        actualizarMarcadoresEnMapa(data.socios);
                        document.getElementById('estadoMonitoreo').textContent = 
                            `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()} - ${data.totalSocios} socios`;
                    } else {
                        document.getElementById('estadoMonitoreo').textContent = `Error: ${data.error}`;
                    }
                } catch (error) {
                    console.error('Error al obtener socios:', error);
                    document.getElementById('estadoMonitoreo').textContent = 'Error de conexi√≥n';
                }
            }

            // Actualizar lista en el panel
            function actualizarListaSocios(socios) {
                const listaDiv = document.getElementById('listaSocios');
                
                listaDiv.innerHTML = socios.map(socio => `
                    <div style="padding: 8px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
                        <strong>${socio.nombre}</strong><br>
                        <small>üìÑ DNI: ${socio.dni || 'No disponible'}</small><br>
                        <small>üìç ${socio.lat.toFixed(5)}, ${socio.lng.toFixed(5)}</small><br>
                        <small style="color: #28a745;">‚úÖ En el coto</small>
                    </div>
                `).join('');
            }

            // Actualizar marcadores en el mapa
            function actualizarMarcadoresEnMapa(socios) {
                // Limpiar marcadores anteriores
                Object.values(marcadoresSocios).forEach(marker => {
                    if (marker) window.superAdminMap.removeLayer(marker);
                });
                marcadoresSocios = {};
                
                // Agregar nuevos marcadores
                socios.forEach(socio => {
                    const marker = L.marker([socio.lat, socio.lng])
                        .bindPopup(`<b>${socio.nombre}</b><br>üìç En el coto<br>${socio.lat.toFixed(5)}, ${socio.lng.toFixed(5)}`)
                        .addTo(window.superAdminMap);
                    
                    marcadoresSocios[socio.id] = marker;
                });
            }

            // Controles de monitoreo
            function iniciarMonitoreo() {
                if (window.intervaloMonitoreo) {
                    clearInterval(window.intervaloMonitoreo);
                }
                window.intervaloMonitoreo = setInterval(actualizarSociosEnCoto, 5000);
                document.getElementById('btnIniciarMonitoreo').style.display = 'none';
                document.getElementById('btnDetenerMonitoreo').style.display = 'block';
                document.getElementById('estadoMonitoreo').textContent = 'Monitoreo activo - Cargando...';
                
                // Primera actualizaci√≥n inmediata
                actualizarSociosEnCoto();
            }

            window.detenerMonitoreo = function() {
                if (intervaloMonitoreo) {
                    clearInterval(intervaloMonitoreo);
                    intervaloMonitoreo = null;
                }
                
                document.getElementById('btnIniciarMonitoreo').style.display = 'block';
                document.getElementById('btnDetenerMonitoreo').style.display = 'none';
                document.getElementById('estadoMonitoreo').textContent = 'Monitoreo detenido';
                
                // Limpiar marcadores
                Object.values(marcadoresSocios).forEach(marker => {
                    if (marker) window.superAdminMap.removeLayer(marker);
                });
                marcadoresSocios = {};
                
                // Limpiar lista
                document.getElementById('listaSocios').innerHTML = 
                    '<div style="text-align: center; color: #666; padding: 20px;">Monitoreo no activo</div>';
            }

            document.getElementById('btnIniciarMonitoreo').addEventListener('click', iniciarMonitoreo);
            document.getElementById('btnDetenerMonitoreo').addEventListener('click', detenerMonitoreo);

            // ========== GESTI√ìN DE ADMINISTRADORES ==========

            // Mostrar panel de administradores
            document.getElementById('gestionarAdmins').addEventListener('click', function() {
                mostrarPanelAdmin();
                cerrarMenu();
            });

            function mostrarPanelAdmin() {
            // Crear overlay si no existe
            if (!document.getElementById('adminOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'adminOverlay';
                document.getElementById('superAdminScreen').appendChild(overlay);
            }
            
            document.getElementById('adminOverlay').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'block';
            menuItems.style.display = 'none';
            
            // Limpiar formulario al abrir el panel
            cancelarEdicionAdmin();
            
            // Cargar lista de cotos para el select
            cargarCotosParaAdmin();
            // Cargar administradores existentes
            cargarAdministradores();
        }

            function cerrarPanelAdmin() {
                document.getElementById('adminOverlay').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'none';
            }

            // Cargar cotos para el select de administradores
            async function cargarCotosParaAdmin() {
                try {
                    const response = await fetch('/areas');
                    const areas = await response.json();
                    
                    const select = document.getElementById('adminCoto');
                    select.innerHTML = '<option value="">-- Selecciona un coto --</option>';
                    
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.id;
                        option.textContent = area.nombre;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error cargando cotos para admin:', error);
                }
            }

            // Funci√≥n para crear administrador
            async function crearAdministrador() {
                if (modoEdicionAdmin) {
                    await actualizarAdministrador(adminEditandoId);
                    return;
                }

                const nombre = document.getElementById('adminNombre').value.trim();
                const usuario = document.getElementById('adminUsuarioPanel').value.trim();
                const clave = document.getElementById('adminClave').value.trim();
                const email = document.getElementById('adminEmail').value.trim();
                const tipo = document.getElementById('adminTipo').value;
                const idCoto = document.getElementById('adminCoto').value;
                const mensajeDiv = document.getElementById('mensajeAdmin');

                // Validaciones b√°sicas
                if (!nombre || !usuario || !clave || !email || !tipo) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Todos los campos son obligatorios</span>';
                    return;
                }

                if (tipo === 'admin' && !idCoto) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Debes seleccionar un coto para administradores de coto</span>';
                    return;
                }

                if (clave.length < 6) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå La contrase√±a debe tener al menos 6 caracteres</span>';
                    return;
                }

                try {
                    const response = await fetch('/admin/crear', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            usuario, 
                            clave, 
                            nombre, 
                            email, 
                            tipo: tipo,
                            idCoto: tipo === 'admin' ? parseInt(idCoto) : null
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        mensajeDiv.innerHTML = '<span style="color: green;">‚úÖ ' + data.message + '</span>';
                        
                        // Limpiar formulario
                        limpiarFormularioAdmin();
                        
                        // Recargar lista de administradores
                        cargarAdministradores();
                        
                        // Ocultar mensaje despu√©s de 3 segundos
                        setTimeout(() => {
                            mensajeDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        mensajeDiv.innerHTML = '<span style="color: red;">‚ùå ' + data.error + '</span>';
                    }
                } catch (error) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n con el servidor</span>';
                    console.error('Error:', error);
                }
            }

            // Cargar lista de administradores
            async function cargarAdministradores() {
                try {
                    const response = await fetch('/admin/listar');
                    const administradores = await response.json();
                    
                    listaAdministradores = administradores;
                    actualizarListaAdministradores(administradores);
                } catch (error) {
                    console.error('Error cargando administradores:', error);
                    document.getElementById('listaAdmins').innerHTML = 
                        '<div style="text-align: center; color: red; padding: 20px;">Error cargando administradores</div>';
                }
            }

            // Actualizar la lista en el panel
            function actualizarListaAdministradores(admins) {
                const listaDiv = document.getElementById('listaAdmins');
                
                if (admins.length === 0) {
                    listaDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No hay administradores registrados</div>';
                    return;
                }
                
                listaDiv.innerHTML = admins.map(admin => `
                    <div class="admin-item">
                        <div class="admin-info">
                            <h4>${admin.NOMBRE}</h4>
                            <p><strong>Usuario:</strong> ${admin.USUARIO} | <strong>Email:</strong> ${admin.EMAIL || 'No especificado'}</p>
                            <p><strong>Tipo:</strong> ${admin.TIPO === 'superadmin' ? 'Super Administrador' : 'Administrador de Coto'} | 
                               <p><strong>Coto:</strong> ${admin.COTO_NOMBRE || 'Todos los cotos'} | 
                               <strong>ID Coto:</strong> ${admin.ID_COTO || 'N/A'} | 
                               <strong>Estado:</strong> 
                                <span class="${admin.ACTIVO ? 'status-activo' : 'status-inactivo'}">
                                    ${admin.ACTIVO ? 'ACTIVO' : 'INACTIVO'}
                                </span>
                            </p>
                        </div>
                        <div class="admin-actions">
                            ${admin.ACTIVO ? 
                                `<button class="btn-desactivar" onclick="cambiarEstadoAdmin(${admin.ID}, 0)">Desactivar</button>` :
                                `<button class="btn-activar" onclick="cambiarEstadoAdmin(${admin.ID}, 1)">Activar</button>`
                            }
                            <button class="btn-editar" onclick="editarAdministrador(${admin.ID})">Editar</button>
                        </div>
                    </div>
                `).join('');
            }

            // Cambiar estado de administrador (activar/desactivar)
            window.cambiarEstadoAdmin = async function(idAdmin, nuevoEstado) {
                try {
                    const response = await fetch('/admin/estado', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            id: idAdmin,
                            activo: nuevoEstado
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Recargar lista
                        cargarAdministradores();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n');
                    console.error('Error:', error);
                }
            }

            // Funci√≥n para editar administrador
            window.editarAdministrador = function(idAdmin) {
                const admin = listaAdministradores.find(a => a.ID === idAdmin);
                if (admin) {
                    // Activar modo edici√≥n
                    modoEdicionAdmin = true;
                    adminEditandoId = idAdmin;
                    
                    // Llenar el formulario con los datos del administrador
                    document.getElementById('adminNombre').value = admin.NOMBRE;
                    document.getElementById('adminUsuarioPanel').value = admin.USUARIO;
                    document.getElementById('adminEmail').value = admin.EMAIL || '';
                    
                    // Establecer el tipo de administrador
                    document.getElementById('adminTipo').value = admin.TIPO;
                    
                    // Mostrar/ocultar selecci√≥n de coto seg√∫n el tipo
                    const cotoSelection = document.getElementById('cotoSelection');
                    if (admin.TIPO === 'admin') {
                        cotoSelection.style.display = 'block';
                        if (admin.ID_COTO && admin.ID_COTO !== 0) {
                            document.getElementById('adminCoto').value = admin.ID_COTO;
                        }
                    } else {
                        cotoSelection.style.display = 'none';
                    }
                    
                    // Cambiar el texto del bot√≥n a "Actualizar"
                    const btnAccion = document.getElementById('btnAccionAdmin');
                    btnAccion.textContent = 'üîÑ Actualizar Administrador';
                    btnAccion.style.background = '#ffc107';
                    btnAccion.style.color = 'black';
                    
                    // Crear o mostrar bot√≥n cancelar entre el t√≠tulo y la X
                    let cancelarBtn = document.getElementById('btnCancelarEdicion');
                    if (!cancelarBtn) {
                        cancelarBtn = document.createElement('button');
                        cancelarBtn.id = 'btnCancelarEdicion';
                        cancelarBtn.textContent = '‚ùå Cancelar';
                        cancelarBtn.style.padding = '4px 8px';
                        cancelarBtn.style.background = '#dc3545';
                        cancelarBtn.style.color = 'white';
                        cancelarBtn.style.border = 'none';
                        cancelarBtn.style.borderRadius = '4px';
                        cancelarBtn.style.cursor = 'pointer';
                        cancelarBtn.style.fontSize = '11px';
                        cancelarBtn.style.margin = '0 10px';
                        cancelarBtn.onclick = cancelarEdicionAdmin;
                        
                        // Insertar entre el t√≠tulo y la X de cerrar
                        const header = document.querySelector('#adminPanel > div:first-child');
                        const titulo = header.querySelector('h3');
                        const botonCerrar = header.querySelector('button[onclick="cerrarPanelAdmin()"]');
                        
                        header.insertBefore(cancelarBtn, botonCerrar);
                    }
                    
                    cancelarBtn.style.display = 'block';
                    
                    // Limpiar campo de contrase√±a
                    document.getElementById('adminClave').value = '';
                    document.getElementById('adminClave').placeholder = 'Dejar vac√≠o para mantener la actual';
                    
                    // Mostrar mensaje informativo
                    const mensajeDiv = document.getElementById('mensajeAdmin');
                    mensajeDiv.innerHTML = '<span style="color: #ffc107;">‚úèÔ∏è Editando administrador: ' + admin.NOMBRE + '</span>';
                }
            };

            // Funci√≥n para actualizar administrador
            async function actualizarAdministrador(idAdmin) {
                const nombre = document.getElementById('adminNombre').value.trim();
                const usuario = document.getElementById('adminUsuarioPanel').value.trim();
                const clave = document.getElementById('adminClave').value.trim();
                const email = document.getElementById('adminEmail').value.trim();
                const tipo = document.getElementById('adminTipo').value;
                const idCoto = document.getElementById('adminCoto').value;
                const mensajeDiv = document.getElementById('mensajeAdmin');

                // Validaciones b√°sicas
                if (!nombre || !usuario || !email || !tipo) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Nombre, usuario, email y tipo son obligatorios</span>';
                    return;
                }

                if (tipo === 'admin' && !idCoto) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Debes seleccionar un coto para administradores de coto</span>';
                    return;
                }

                try {
                    const datosActualizacion = {
                        id: idAdmin,
                        nombre: nombre,
                        usuario: usuario,
                        email: email,
                        tipo: tipo,
                        idCoto: tipo === 'admin' ? parseInt(idCoto) : null
                    };

                    // Solo incluir la contrase√±a si se proporcion√≥ una nueva
                    if (clave && clave.length > 0) {
                        if (clave.length < 6) {
                            mensajeDiv.innerHTML = '<span style="color: red;">‚ùå La contrase√±a debe tener al menos 6 caracteres</span>';
                            return;
                        }
                        datosActualizacion.clave = clave;
                    }

                    const response = await fetch('/admin/actualizar', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(datosActualizacion)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        mensajeDiv.innerHTML = '<span style="color: green;">‚úÖ ' + data.message + '</span>';
                        
                        // Restaurar formulario a estado inicial
                        cancelarEdicionAdmin();
                        
                        // Recargar lista de administradores
                        cargarAdministradores();
                        
                        // Ocultar mensaje despu√©s de 3 segundos
                        setTimeout(() => {
                            mensajeDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        mensajeDiv.innerHTML = '<span style="color: red;">‚ùå ' + data.error + '</span>';
                    }
                } catch (error) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n con el servidor</span>';
                    console.error('Error:', error);
                }
            }

            // Funci√≥n para cancelar edici√≥n
            function cancelarEdicionAdmin() {
                // Limpiar formulario
                limpiarFormularioAdmin();
                
                // Restaurar variables de estado
                modoEdicionAdmin = false;
                adminEditandoId = null;
                
                // Ocultar bot√≥n cancelar
                const cancelarBtn = document.getElementById('btnCancelarEdicion');
                if (cancelarBtn) {
                    cancelarBtn.style.display = 'none';
                }
                
                // Limpiar mensaje
                const mensajeDiv = document.getElementById('mensajeAdmin');
                mensajeDiv.innerHTML = '';
            }

            // Funci√≥n para limpiar el formulario
            function limpiarFormularioAdmin() {
                document.getElementById('adminNombre').value = '';
                document.getElementById('adminUsuarioPanel').value = '';
                document.getElementById('adminClave').value = '';
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminTipo').value = 'admin';
                document.getElementById('adminCoto').value = '';
                
                // Restaurar placeholder de contrase√±a
                document.getElementById('adminClave').placeholder = 'M√≠nimo 6 caracteres';
                
                // Restaurar bot√≥n a estado "A√±adir"
                const btnAccion = document.getElementById('btnAccionAdmin');
                btnAccion.textContent = '‚úÖ A√±adir Administrador';
                btnAccion.style.background = '#28a745';
                btnAccion.style.color = 'white';
                btnAccion.onclick = crearAdministrador;
            }

            // ========== FUNCIONALIDAD DE MODIFICACI√ìN DE COTOS ==========

            document.getElementById('modificarCoto').addEventListener('click', function() {
                mostrarPanelModificacion();
                cerrarMenu();
            });

            function mostrarPanelModificacion() {
                // Crear overlay si no existe
                if (!document.getElementById('adminOverlay')) {
                    const overlay = document.createElement('div');
                    overlay.id = 'adminOverlay';
                    document.getElementById('superAdminScreen').appendChild(overlay);
                }
                
                document.getElementById('adminOverlay').style.display = 'block';
                document.getElementById('modificarPanel').style.display = 'block';
                menuItems.style.display = 'none';
                
                // Cargar lista de cotos para modificar
                cargarCotosParaModificacion();
            }

            function cerrarPanelModificacion() {
                document.getElementById('adminOverlay').style.display = 'none';
                document.getElementById('modificarPanel').style.display = 'none';
                
                // Limpiar edici√≥n si estaba activa
                if (editLayer) {
                    window.superAdminMap.removeLayer(editLayer);
                    editLayer = null;
                }
                cotoEnEdicion = null;
                document.getElementById('btnGuardarCambios').style.display = 'none';
                document.getElementById('btnEditarCoto').style.display = 'none';
                document.getElementById('mensajeModificacion').innerHTML = '';
                
                // Salir del modo edici√≥n si estaba activo
                salirModoEdicion();
            }

            // Cargar cotos para el select de modificaci√≥n
            async function cargarCotosParaModificacion() {
                try {
                    const response = await fetch('/areas');
                    const areas = await response.json();
                    
                    const select = document.getElementById('selectCotoModificar');
                    select.innerHTML = '<option value="">-- Selecciona un coto --</option>';
                    
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.id;
                        option.textContent = area.nombre;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error cargando cotos para modificaci√≥n:', error);
                    document.getElementById('mensajeModificacion').innerHTML = 
                        '<span style="color: red;">‚ùå Error cargando cotos</span>';
                }
            }

            // Cargar coto seleccionado para edici√≥n
            document.getElementById('btnCargarCoto').addEventListener('click', async function() {
                const cotoId = document.getElementById('selectCotoModificar').value;
                const mensajeDiv = document.getElementById('mensajeModificacion');
                
                if (!cotoId) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Selecciona un coto primero</span>';
                    return;
                }

                try {
                    const response = await fetch(`/areas/${cotoId}`);
                    const area = await response.json();
                    
                    if (!area.coords || area.coords.length === 0) {
                        mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Este coto no tiene coordenadas v√°lidas</span>';
                        return;
                    }

                    // Limpiar cualquier pol√≠gono existente
                    drawnItems.clearLayers();
                    if (editLayer) {
                        window.superAdminMap.removeLayer(editLayer);
                    }

                    // Crear pol√≠gono
                    editPolygon = L.polygon(area.coords, {
                        color: "#2A9DF4",
                        weight: 4,
                        fillOpacity: 0.3
                    }).addTo(window.superAdminMap);

                    // Centrar el mapa en el pol√≠gono
                    window.superAdminMap.fitBounds(editPolygon.getBounds());
                    
                    // Guardar referencia al coto en edici√≥n
                    cotoEnEdicion = {
                        id: area.id,
                        nombre: area.nombre,
                        coordsOriginales: area.coords
                    };
                    
                    // Mostrar botones
                    document.getElementById('btnEditarCoto').style.display = 'block';
                    document.getElementById('btnGuardarCambios').style.display = 'none';
                    
                    mensajeDiv.innerHTML = '<span style="color: green;">‚úÖ Coto cargado. Haz clic en "Editar Coto" para modificarlo.</span>';
                    
                } catch (error) {
                    console.error('Error cargando coto para edici√≥n:', error);
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Error cargando el coto</span>';
                }
            });

            // Iniciar edici√≥n del coto
            document.getElementById('btnEditarCoto').addEventListener('click', function() {
                if (!cotoEnEdicion || !editPolygon) {
                    alert('No hay ning√∫n coto cargado para editar');
                    return;
                }

                iniciarModoEdicion();
            });

            function iniciarModoEdicion() {
                if (!editPolygon) return;

                // Ocultar panel de modificaci√≥n
                document.getElementById('modificarPanel').style.display = 'none';
                document.getElementById('adminOverlay').style.display = 'none';
                
                // Ocultar men√∫
                menuItems.style.display = 'none';
                
                // Ocultar coordenadas de socios (monitoreo)
                document.getElementById('monitoreoPanel').style.display = 'none';
                document.getElementById('info').style.display = 'none';
                document.getElementById('posicion').style.display = 'none';
                
                // Detener monitoreo si estaba activo
                if (intervaloMonitoreo) {
                    detenerMonitoreo();
                }
                
                // Limpiar marcadores de socios del mapa
                Object.values(marcadoresSocios).forEach(marker => {
                    if (marker) window.superAdminMap.removeLayer(marker);
                });
                marcadoresSocios = {};
                
                // Mostrar indicador de modo edici√≥n
                document.getElementById('modoEdicion').style.display = 'block';
                document.getElementById('modoEdicion').textContent = `‚úèÔ∏è EDITANDO: ${cotoEnEdicion.nombre}`;
                
                // Mostrar bot√≥n finalizar edici√≥n
                document.getElementById('btnFinalizarEdicion').style.display = 'block';
                
                // Cambiar estilo del pol√≠gono para indicar edici√≥n
                editPolygon.setStyle({
                    color: "#ff7800",
                    weight: 4,
                    fillOpacity: 0.2
                });
                
                // Hacer el pol√≠gono editable
                editLayer = new L.FeatureGroup([editPolygon]);
                window.superAdminMap.addLayer(editLayer);
                
                // Habilitar edici√≥n
                editPolygon.editing.enable();
                
                modoEdicionActivo = true;
                
                console.log('‚úÖ Modo edici√≥n activado para coto:', cotoEnEdicion.nombre);
            }

            function salirModoEdicion() {
                // Ocultar indicadores de edici√≥n
                document.getElementById('modoEdicion').style.display = 'none';
                document.getElementById('btnFinalizarEdicion').style.display = 'none';
                
                // Restaurar elementos normales
                document.getElementById('info').style.display = 'block';
                document.getElementById('info').textContent = 'Dibuja un pol√≠gono para marcar el coto';
                
                if (editPolygon) {
                    // Restaurar estilo normal
                    editPolygon.setStyle({
                        color: "#2A9DF4",
                        weight: 4,
                        fillOpacity: 0.3
                    });
                    
                    // Deshabilitar edici√≥n
                    if (editPolygon.editing) {
                        editPolygon.editing.disable();
                    }
                }
                
                if (editLayer) {
                    window.superAdminMap.removeLayer(editLayer);
                    editLayer = null;
                }
                
                modoEdicionActivo = false;
                
                console.log('‚ùå Modo edici√≥n desactivado');
            }

            // Finalizar edici√≥n
            document.getElementById('btnFinalizarEdicion').addEventListener('click', function() {
                salirModoEdicion();
                
                // Mostrar nuevamente el panel de modificaci√≥n
                document.getElementById('modificarPanel').style.display = 'block';
                document.getElementById('adminOverlay').style.display = 'block';
                
                // Mostrar bot√≥n guardar cambios
                document.getElementById('btnGuardarCambios').style.display = 'block';
                document.getElementById('btnEditarCoto').style.display = 'none';
                
                document.getElementById('mensajeModificacion').innerHTML = 
                    '<span style="color: green;">‚úÖ Edici√≥n finalizada. Puedes guardar los cambios.</span>';
            });

            // Guardar cambios del coto modificado
            document.getElementById('btnGuardarCambios').addEventListener('click', async function() {
                if (!cotoEnEdicion || !editPolygon) {
                    alert('No hay ning√∫n coto en edici√≥n');
                    return;
                }

                const mensajeDiv = document.getElementById('mensajeModificacion');
                const nuevasCoords = editPolygon.getLatLngs()[0].map(p => ({ lat: p.lat, lng: p.lng }));

                if (nuevasCoords.length < 3) {
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå El pol√≠gono debe tener al menos 3 puntos</span>';
                    return;
                }

                try {
                    const response = await fetch('/modificar-coto', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: cotoEnEdicion.id,
                            coordenadas: nuevasCoords
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        mensajeDiv.innerHTML = '<span style="color: green;">‚úÖ ' + data.mensaje + '</span>';
                        
                        // Actualizar la lista de cotos
                        cargarAreas();
                        cargarCotosParaModificacion();
                        
                        // Cerrar panel despu√©s de 2 segundos
                        setTimeout(() => {
                            cerrarPanelModificacion();
                        }, 2000);
                    } else {
                        mensajeDiv.innerHTML = '<span style="color: red;">‚ùå ' + data.error + '</span>';
                    }
                } catch (error) {
                    console.error('Error guardando cambios:', error);
                    mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n con el servidor</span>';
                }
            });

            // Cancelar modificaci√≥n
            document.getElementById('btnCancelarModificacion').addEventListener('click', function() {
                cerrarPanelModificacion();
            });

            // Cerrar paneles al hacer clic fuera de ellos
            document.addEventListener('click', function(event) {
                const registroPanel = document.getElementById('registroPanel');
                const monitoreoPanel = document.getElementById('monitoreoPanel');
                const adminPanel = document.getElementById('adminPanel');
                const modificarPanel = document.getElementById('modificarPanel');
                const menuBtn = document.getElementById('menuToggle');
                const registrarBtn = document.getElementById('registrarSocio');
                const monitorearBtn = document.getElementById('monitorearSocios');
                const gestionarBtn = document.getElementById('gestionarAdmins');
                const modificarBtn = document.getElementById('modificarCoto');
                const adminOverlay = document.getElementById('adminOverlay');
                
                // Cerrar registro panel si se hace clic fuera
                if (registroPanel.style.display === 'block' && 
                    !registroPanel.contains(event.target) && 
                    !menuBtn.contains(event.target) &&
                    !registrarBtn.contains(event.target)) {
                    registroPanel.style.display = 'none';
                }

                // Cerrar modificar panel si se hace clic en overlay
                if (adminOverlay && adminOverlay.style.display === 'block' && 
                    event.target === adminOverlay && 
                    modificarPanel.style.display === 'block') {
                    cerrarPanelModificacion();
                }
            });

            window.superAdminMap.zoomControl.remove();
        }

        // ========== FUNCIONALIDAD DE GESTI√ìN DE PERROS ==========

        // Variables globales para perros
        let listaPerrosGlobal = [];
        let marcadoresPerrosGlobal = new Map();
        let intervaloMonitoreoPerrosGlobal = null;
        let modoEdicionPerroGlobal = false;
        let perroEditandoIdGlobal = null;

        // Mostrar panel de perros
        document.getElementById('gestionarPerros').addEventListener('click', function() {
            mostrarPanelPerros();
            cerrarMenu();
        });

        function mostrarPanelPerros() {
            // Crear overlay si no existe
            if (!document.getElementById('adminOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'adminOverlay';
                document.getElementById('superAdminScreen').appendChild(overlay);
            }
            
            document.getElementById('adminOverlay').style.display = 'block';
            document.getElementById('perrosPanel').style.display = 'block';
            menuItems.style.display = 'none';
            
            // Limpiar formulario al abrir el panel
            cancelarEdicionPerro();
            
            // Cargar lista de SOCIOS para el select
            cargarSociosParaPerros();
            
            // Cargar perros existentes
            cargarPerros();
        }

        function cerrarPanelPerros() {
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('perrosPanel').style.display = 'none';
        }

        // Cargar socios para el select de perros
        async function cargarSociosParaPerros() {
            try {
                console.log("üîÑ Iniciando carga de socios para perros...");
                
                const response = await fetch('/socios');
                console.log('üîç Estado respuesta:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const socios = await response.json();
                console.log('üìã Socios recibidos del backend:', socios);
                
                const select = document.getElementById('perroSocio');
                console.log('üîç Elemento select encontrado:', select);
                
                if (!select) {
                    console.error('‚ùå ERROR: No se encontr√≥ el elemento select con id "perroSocio"');
                    return;
                }
                
                // Limpiar y verificar
                select.innerHTML = '<option value="">-- Sin asignar --</option>';
                console.log('üîç Select limpiado');
                
                // A√±adir cada socio
                socios.forEach((socio, index) => {
                    console.log(`   üë• Procesando socio ${index + 1}:`, socio);
                    const option = document.createElement('option');
                    option.value = socio.ID;
                    const texto = `${socio.NOMBRE} (${socio.USUARIO})${socio.DNI ? ` - DNI: ${socio.DNI}` : ''}`;
                    option.textContent = texto;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${socios.length} socios a√±adidos al select`);
                console.log('üîç HTML final del select:', select.innerHTML);
                
                // Forzar que se muestre
                select.style.display = 'block';
                select.style.opacity = '1';
                select.style.visibility = 'visible';
                
            } catch (error) {
                console.error('‚ùå Error cargando socios para perros:', error);
                
                // Fallback: mostrar mensaje en el select
                const select = document.getElementById('perroSocio');
                if (select) {
                    select.innerHTML = '<option value="">‚ö†Ô∏è Error cargando socios</option>';
                }
            }
        }

        // Cargar lista de perros
        async function cargarPerros() {
            try {
                const response = await fetch('/perros');
                const perros = await response.json();
                
                listaPerrosGlobal = perros;
                actualizarListaPerros(perros);
            } catch (error) {
                console.error('Error cargando perros:', error);
                document.getElementById('listaPerros').innerHTML = 
                    '<div style="text-align: center; color: red; padding: 20px;">Error cargando perros</div>';
            }
        }

        // Actualizar la lista de perros en el panel
        function actualizarListaPerros(perros) {
            const listaDiv = document.getElementById('listaPerros');
            
            if (perros.length === 0) {
                listaDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No hay perros registrados</div>';
                return;
            }
            
            listaDiv.innerHTML = perros.map(perro => `
                <div class="perro-item">
                    <div class="perro-info">
                        <h4>${perro.NOMBRE}</h4>
                        <p><strong>Identificador:</strong> ${perro.IDENTIFICADOR}</p>
                        ${perro.POS_X && perro.POS_Y ? 
                            `<p class="perro-ubicacion">üìç ${perro.POS_X.toFixed(6)}, ${perro.POS_Y.toFixed(6)}</p>` : 
                            `<p style="color: #999;">üìç Sin ubicaci√≥n registrada</p>`
                        }
                        <p><strong>Propietario:</strong> 
                            <span id="propietario-${perro.ID}" style="color: #666;">
                                Cargando...
                            </span>
                        </p>
                        <p><strong>Estado:</strong> 
                            <span class="status-activo">ACTIVO</span>
                        </p>
                    </div>
                    <div class="perro-actions">
                        <button class="btn-editar-perro" onclick="editarPerro(${perro.ID})">Editar</button>
                        <button class="btn-ubicacion" onclick="actualizarUbicacionPerro(${perro.ID})">üìç Ubicaci√≥n</button>
                        ${perro.POS_X && perro.POS_Y ? 
                            `<button class="btn-asignar" onclick="mostrarEnMapa(${perro.POS_Y}, ${perro.POS_X}, '${perro.NOMBRE}')">üó∫Ô∏è Ver</button>` : 
                            ''
                        }
                    </div>
                </div>
            `).join('');
            
            // Ahora cargamos la informaci√≥n del socio para cada perro
            cargarPropietariosPerros(perros);
        }

        // Mostrar perro en el mapa
        function mostrarEnMapa(lat, lng, nombre) {
            if (!window.superAdminMap) return;
            
            // Limpiar marcadores anteriores de perros
            marcadoresPerrosGlobal.forEach(marker => {
                window.superAdminMap.removeLayer(marker);
            });
            marcadoresPerrosGlobal.clear();
            
            // Crear marcador especial para perro
            const perroIcon = L.divIcon({
                className: 'perro-marcador',
                html: '<div style="background: #ff6b35; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">üêï</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([lat, lng], { icon: perroIcon })
                .bindPopup(`<b>${nombre}</b><br>üìç Perro de caza<br>${lat.toFixed(5)}, ${lng.toFixed(5)}`)
                .addTo(window.superAdminMap);
            
            marcadoresPerrosGlobal.set('perro-actual', marker);
            window.superAdminMap.setView([lat, lng], 15);
            
            cerrarPanelPerros();
        }

        // Usar ubicaci√≥n actual para el perro
        function usarUbicacionActualPerro() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        document.getElementById('perroPosY').value = position.coords.latitude;
                        document.getElementById('perroPosX').value = position.coords.longitude;
                        document.getElementById('mensajePerro').innerHTML = 
                            '<span style="color: green;">üìç Ubicaci√≥n obtenida correctamente</span>';
                    },
                    error => {
                        document.getElementById('mensajePerro').innerHTML = 
                            '<span style="color: red;">‚ùå Error obteniendo ubicaci√≥n: ' + error.message + '</span>';
                    }
                );
            } else {
                document.getElementById('mensajePerro').innerHTML = 
                    '<span style="color: red;">‚ùå Geolocalizaci√≥n no soportada</span>';
            }
        }

        function limpiarCoordenadasPerro() {
            document.getElementById('perroPosX').value = '';
            document.getElementById('perroPosY').value = '';
        }

        // Guardar o actualizar perro
        async function guardarPerro() {
            const nombre = document.getElementById('perroNombre').value.trim();
            const identificador = document.getElementById('perroIdentificador').value.trim();
            const pos_x = document.getElementById('perroPosX').value;
            const pos_y = document.getElementById('perroPosY').value;
            const idSocio = document.getElementById('perroSocio').value; // Cambiado de idCoto a idSocio
            const mensajeDiv = document.getElementById('mensajePerro');

            // Validaciones
            if (!nombre || !identificador) {
                mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Nombre e identificador son obligatorios</span>';
                return;
            }

            const perroData = {
                nombre: nombre,
                identificador: identificador,
                pos_x: pos_x ? parseFloat(pos_x) : null,
                pos_y: pos_y ? parseFloat(pos_y) : null,
                idSocio: idSocio || null // Cambiado de idCoto a idSocio
            };

            try {
                let response;
                
                if (modoEdicionPerroGlobal && perroEditandoIdGlobal) {
                    // Actualizar perro existente
                    response = await fetch(`/perros/${perroEditandoIdGlobal}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(perroData)
                    });
                } else {
                    // Crear nuevo perro
                    response = await fetch('/perros', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(perroData)
                    });
                }

                const data = await response.json();

                if (response.ok) {
                    mensajeDiv.innerHTML = `<span style="color: green;">‚úÖ ${data.message || data.mensaje}</span>`;
                    
                    // Limpiar formulario y recargar lista
                    cancelarEdicionPerro();
                    cargarPerros();
                    
                    setTimeout(() => {
                        mensajeDiv.innerHTML = '';
                    }, 3000);
                } else {
                    mensajeDiv.innerHTML = `<span style="color: red;">‚ùå ${data.error || 'Error desconocido'}</span>`;
                }
            } catch (error) {
                mensajeDiv.innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n con el servidor</span>';
                console.error('Error:', error);
            }
        }

        async function cargarPropietariosPerros(perros) {
            try {
                // Obtener todos los socios para el mapeo
                const responseSocios = await fetch('/socios');
                const socios = await responseSocios.json();
                
                // Crear un mapa de socios por ID para b√∫squeda r√°pida
                const sociosMap = {};
                socios.forEach(socio => {
                    sociosMap[socio.ID] = socio;
                });
                
                // Para cada perro, obtener su propietario
                for (const perro of perros) {
                    try {
                        const response = await fetch(`/perros/${perro.ID}/propietario`);
                        const propietarioData = await response.json();
                        
                        if (response.ok && propietarioData.propietario) {
                            const socioId = propietarioData.propietario.ID_SOCIO;
                            const socio = sociosMap[socioId];
                            
                            if (socio) {
                                const propietarioElement = document.getElementById(`propietario-${perro.ID}`);
                                if (propietarioElement) {
                                    propietarioElement.textContent = `${socio.NOMBRE} (${socio.USUARIO})`;
                                    propietarioElement.style.color = '#2A9DF4';
                                }
                            }
                        } else {
                            const propietarioElement = document.getElementById(`propietario-${perro.ID}`);
                            if (propietarioElement) {
                                propietarioElement.textContent = 'Sin asignar';
                                propietarioElement.style.color = '#999';
                            }
                        }
                    } catch (error) {
                        console.error(`Error cargando propietario para perro ${perro.ID}:`, error);
                        const propietarioElement = document.getElementById(`propietario-${perro.ID}`);
                        if (propietarioElement) {
                            propietarioElement.textContent = 'Error al cargar';
                            propietarioElement.style.color = '#dc3545';
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando socios para propietarios:', error);
            }
        }

        // Editar perro
        function editarPerro(idPerro) {
            const perro = listaPerrosGlobal.find(p => p.ID === idPerro);
            if (perro) {
                modoEdicionPerroGlobal = true;
                perroEditandoIdGlobal = idPerro;
                
                // Llenar formulario
                document.getElementById('perroNombre').value = perro.NOMBRE;
                document.getElementById('perroIdentificador').value = perro.IDENTIFICADOR;
                document.getElementById('perroPosX').value = perro.POS_X || '';
                document.getElementById('perroPosY').value = perro.POS_Y || '';
                
                // Cambiar t√≠tulo y bot√≥n
                document.getElementById('tituloFormPerro').textContent = '‚úèÔ∏è Editar Perro de Caza';
                document.getElementById('btnAccionPerro').textContent = 'üîÑ Actualizar Perro';
                document.getElementById('btnAccionPerro').style.background = '#ffc107';
                document.getElementById('btnAccionPerro').style.color = 'black';
                
                // Mostrar bot√≥n cancelar
                let cancelarBtn = document.getElementById('btnCancelarEdicionPerro');
                if (!cancelarBtn) {
                    cancelarBtn = document.createElement('button');
                    cancelarBtn.id = 'btnCancelarEdicionPerro';
                    cancelarBtn.textContent = '‚ùå Cancelar Edici√≥n';
                    cancelarBtn.style.cssText = `
                        width: 100%; 
                        padding: 8px; 
                        background: #dc3545; 
                        color: white; 
                        border: none; 
                        border-radius: 4px; 
                        cursor: pointer; 
                        margin-top: 10px;
                        font-size: 12px;
                    `;
                    cancelarBtn.onclick = cancelarEdicionPerro;
                    
                    const formDiv = document.querySelector('.perro-form');
                    formDiv.appendChild(cancelarBtn);
                }
                
                cancelarBtn.style.display = 'block';
                
                // Cargar el socio propietario actual
                cargarSocioPropietarioActual(idPerro);
                
                // Mensaje informativo
                document.getElementById('mensajePerro').innerHTML = 
                    `<span style="color: #ffc107;">‚úèÔ∏è Editando perro: ${perro.NOMBRE}</span>`;
            }
        }

        // Funci√≥n para cargar el socio propietario actual
        async function cargarSocioPropietarioActual(perroId) {
            try {
                const response = await fetch(`/perros/${perroId}/propietario`);
                const data = await response.json();
                
                if (response.ok && data.propietario) {
                    // Establecer el socio actual en el select
                    document.getElementById('perroSocio').value = data.propietario.ID_SOCIO;
                }
            } catch (error) {
                console.error('Error cargando socio propietario:', error);
            }
        }

        // Cancelar edici√≥n de perro
        function cancelarEdicionPerro() {
            // Limpiar formulario
            document.getElementById('perroNombre').value = '';
            document.getElementById('perroIdentificador').value = '';
            document.getElementById('perroPosX').value = '';
            document.getElementById('perroPosY').value = '';
            document.getElementById('perroSocio').value = '';
            
            // Restaurar variables
            modoEdicionPerroGlobal = false;
            perroEditandoIdGlobal = null;
            
            // Restaurar t√≠tulo y bot√≥n
            document.getElementById('tituloFormPerro').textContent = '‚ûï Nuevo Perro de Caza';
            document.getElementById('btnAccionPerro').textContent = '‚úÖ Registrar Perro';
            document.getElementById('btnAccionPerro').style.background = '#28a745';
            document.getElementById('btnAccionPerro').style.color = 'white';
            
            // Ocultar bot√≥n cancelar
            const cancelarBtn = document.getElementById('btnCancelarEdicionPerro');
            if (cancelarBtn) {
                cancelarBtn.style.display = 'none';
            }
            
            // Limpiar mensaje
            document.getElementById('mensajePerro').innerHTML = '';
        }

        // Actualizar ubicaci√≥n de un perro espec√≠fico
        async function actualizarUbicacionPerro(idPerro) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        try {
                            const response = await fetch(`/perros/${idPerro}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    pos_x: lng,
                                    pos_y: lat
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok) {
                                alert(`‚úÖ Ubicaci√≥n actualizada para el perro\nüìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                                cargarPerros();
                            } else {
                                alert('‚ùå Error: ' + data.error);
                            }
                        } catch (error) {
                            alert('‚ùå Error de conexi√≥n');
                        }
                    },
                    error => {
                        alert('‚ùå Error obteniendo ubicaci√≥n: ' + error.message);
                    }
                );
            } else {
                alert('‚ùå Geolocalizaci√≥n no soportada');
            }
        }

        // ========== MONITOREO DE PERROS EN TIEMPO REAL ==========

        // Iniciar monitoreo de perros
        async function iniciarMonitoreoPerros() {
            const panel = document.getElementById('monitoreoPerrosPanel');
            panel.style.display = 'block';
            
            document.getElementById('estadoMonitoreoPerros').textContent = 'üîÑ Monitoreo activo';
            document.getElementById('estadoMonitoreoPerros').style.background = '#d4edda';
            document.getElementById('estadoMonitoreoPerros').style.color = '#155724';
            
            // Detener monitoreo anterior si existe
            if (intervaloMonitoreoPerrosGlobal) {
                clearInterval(intervaloMonitoreoPerrosGlobal);
            }
            
            // Iniciar nuevo intervalo
            intervaloMonitoreoPerrosGlobal = setInterval(actualizarUbicacionesPerros, 5000);
            
            // Primera actualizaci√≥n inmediata
            await actualizarUbicacionesPerros();
            
            console.log('‚úÖ Monitoreo de perros iniciado');
        }

        // Detener monitoreo de perros
        function detenerMonitoreoPerros() {
            if (intervaloMonitoreoPerrosGlobal) {
                clearInterval(intervaloMonitoreoPerrosGlobal);
                intervaloMonitoreoPerrosGlobal = null;
            }
            
            document.getElementById('estadoMonitoreoPerros').textContent = '‚èπÔ∏è Monitoreo detenido';
            document.getElementById('estadoMonitoreoPerros').style.background = '#f8d7da';
            document.getElementById('estadoMonitoreoPerros').style.color = '#721c24';
            
            // Limpiar marcadores del mapa
            marcadoresPerrosGlobal.forEach(marker => {
                if (marker && window.superAdminMap) {
                    window.superAdminMap.removeLayer(marker);
                }
            });
            marcadoresPerrosGlobal.clear();
            
            // Limpiar lista
            document.getElementById('listaPerrosMonitoreo').innerHTML = 
                '<div style="text-align: center; color: #666; padding: 20px;">No hay perros en monitoreo</div>';
            
            console.log('‚ùå Monitoreo de perros detenido');
        }

        // Actualizar ubicaciones de perros
        async function actualizarUbicacionesPerros() {
            try {
                const response = await fetch('/perros/ubicaciones');
                const ubicaciones = await response.json();
                
                // Actualizar lista en panel
                actualizarListaMonitoreoPerros(ubicaciones);
                
                // Actualizar marcadores en mapa
                actualizarMarcadoresPerros(ubicaciones);
                
                // Actualizar contador
                document.getElementById('contadorPerros').textContent = 
                    `${ubicaciones.length} perros activos | √öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Error obteniendo ubicaciones de perros:', error);
                document.getElementById('estadoMonitoreoPerros').textContent = '‚ùå Error de conexi√≥n';
            }
        }

        // Actualizar lista de monitoreo
        function actualizarListaMonitoreoPerros(ubicaciones) {
            const listaDiv = document.getElementById('listaPerrosMonitoreo');
            
            if (ubicaciones.length === 0) {
                listaDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No hay perros con ubicaci√≥n disponible</div>';
                return;
            }
            
            listaDiv.innerHTML = ubicaciones.map(perro => `
                <div class="perro-monitoreo-item">
                    <strong>${perro.nombre}</strong><br>
                    <small>ID: ${perro.identificador}</small><br>
                    <small>üìç ${perro.lat.toFixed(5)}, ${perro.lng.toFixed(5)}</small><br>
                    <small>üë§ ${perro.socioNombre}</small>
                </div>
            `).join('');
        }

        // Actualizar marcadores en el mapa
        function actualizarMarcadoresPerros(ubicaciones) {
            if (!window.superAdminMap) return;
            
            // Limpiar marcadores anteriores
            marcadoresPerrosGlobal.forEach(marker => {
                window.superAdminMap.removeLayer(marker);
            });
            marcadoresPerrosGlobal.clear();
            
            // Crear icono personalizado para perros
            const perroIcon = L.divIcon({
                className: 'perro-marcador',
                html: '<div style="background: #ff6b35; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">üêï</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Agregar nuevos marcadores
            ubicaciones.forEach(perro => {
                const marker = L.marker([perro.lat, perro.lng], { icon: perroIcon })
                    .bindPopup(`
                        <b>${perro.nombre}</b><br>
                        üÜî ${perro.identificador}<br>
                        üìç ${perro.lat.toFixed(5)}, ${perro.lng.toFixed(5)}<br>
                        üë§ ${perro.socioNombre}<br>
                        ‚è∞ ${new Date(perro.timestamp).toLocaleTimeString()}
                    `)
                    .addTo(window.superAdminMap);
                
                marcadoresPerrosGlobal.set(perro.id.toString(), marker);
            });
        }

        // Cerrar panel de monitoreo de perros
        function cerrarMonitoreoPerros() {
            document.getElementById('monitoreoPerrosPanel').style.display = 'none';
            detenerMonitoreoPerros();
        }

        // Para administradores de coto (a√±adir en la funci√≥n inicializarAdminCoto):
        async function cargarPerrosCoto(cotoId) {
            try {
                const response = await fetch(`/cotos/${cotoId}/perros`);
                const perros = await response.json();
                
                // Agregar perros al mapa del administrador
                if (perros.length > 0 && window.adminMap) {
                    perros.forEach(perro => {
                        if (perro.POS_X && perro.POS_Y) {
                            const perroIcon = L.divIcon({
                                className: 'perro-marcador',
                                html: '<div style="background: #ff6b35; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">üêï</div>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            
                            L.marker([perro.POS_Y, perro.POS_X], { icon: perroIcon })
                                .bindPopup(`<b>${perro.NOMBRE}</b><br>üÜî ${perro.IDENTIFICADOR}`)
                                .addTo(window.adminMap);
                        }
                    });
                }
                
                return perros;
            } catch (error) {
                console.error('Error cargando perros del coto:', error);
                return [];
            }
        }

        // ========== FUNCIONALIDAD ADMINISTRADOR DE COTO ==========

        function inicializarAdminCoto(cotoInfo) {
            // Variables para admin de coto
            let currentCotoId = cotoInfo.id;
            let currentCotoCoords = cotoInfo.coordenadas;
            let intervaloMonitoreo = null;
            let marcadoresSocios = {};
            let cotoPolygon = null;
            
            // Variables para perros
            let marcadoresPerrosAdmin = new Map();

            // Inicializar mapa
            window.adminMap = L.map('adminMap', {zoomControl: false}).setView([37.8916, -4.7794], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(window.adminMap);

            // Dibujar pol√≠gono del coto
            if (currentCotoCoords && currentCotoCoords.length > 0) {
                cotoPolygon = L.polygon(currentCotoCoords, {
                    color: '#2A9DF4',
                    fillColor: '#2A9DF4',
                    fillOpacity: 0.3,
                    weight: 3
                }).addTo(window.adminMap);
                
                window.adminMap.fitBounds(cotoPolygon.getBounds());
            }

            // Actualizar UI
            document.getElementById('currentCotoName').textContent = cotoInfo.nombre;
            document.getElementById('currentAdminName').textContent = `Admin: ${currentUser.nombre}`;

            // Funci√≥n para cargar perros del coto (para complementar el monitoreo)
            async function cargarPerrosDelCoto() {
                try {
                    const response = await fetch(`/cotos/${currentCotoId}/perros`);
                    const perros = await response.json();
                    
                    // Limpiar marcadores anteriores de perros (que no sean de socios monitoreados)
                    marcadoresPerrosAdmin.forEach((marker, key) => {
                        if (!key.startsWith('perro-')) {
                            window.adminMap.removeLayer(marker);
                            marcadoresPerrosAdmin.delete(key);
                        }
                    });
                    
                    // Agregar marcadores para perros sin socio o con socio fuera del coto
                    const perrosIcon = L.divIcon({
                        className: 'perro-marcador-secundario',
                        html: `<div style="background: #ffa726; width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px;">üêï</div>`,
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });
                    
                    perros.forEach(perro => {
                        if (perro.POS_X && perro.POS_Y) {
                            // Verificar si este perro ya est√° mostrado como parte de un socio
                            const perroYaMostrado = Array.from(marcadoresPerrosAdmin.keys())
                                .some(key => key === `perro-${perro.ID}`);
                            
                            if (!perroYaMostrado) {
                                const marker = L.marker([perro.POS_Y, perro.POS_X], { icon: perrosIcon })
                                    .bindPopup(`
                                        <b>üêï ${perro.NOMBRE}</b><br>
                                        üÜî ${perro.IDENTIFICADOR}<br>
                                        üìç ${perro.POS_Y.toFixed(5)}, ${perro.POS_X.toFixed(5)}<br>
                                        <small style="color: #666;">Perro del coto (sin socio en √°rea)</small>
                                    `)
                                    .addTo(window.adminMap);
                                
                                marcadoresPerrosAdmin.set(`coto-perro-${perro.ID}`, marker);
                            }
                        }
                    });
                    
                    console.log(`‚úÖ ${perros.length} perros totales en el coto`);
                    
                } catch (error) {
                    console.error('Error cargando perros del coto:', error);
                }
            }

            // Funci√≥n para actualizar estad√≠sticas incluyendo perros
            function actualizarEstadisticasConPerros(numPerros) {
                const statsDiv = document.querySelector('.stats');
                
                // A√±adir estad√≠stica de perros si no existe
                if (!document.getElementById('statPerros')) {
                    statsDiv.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-number" id="totalPerros">${numPerros}</div>
                            <div class="stat-label">Perros</div>
                        </div>
                    `;
                } else {
                    document.getElementById('totalPerros').textContent = numPerros;
                }
            }

            // Cargar perros al iniciar
            cargarPerrosDelCoto();

            // Funciones de monitoreo (socios)
            async function actualizarSociosEnCoto() {
                if (!currentCotoId) return;

                try {
                    // Cambiar a la nueva ruta que incluye perros
                    const response = await fetch(`/monitoreo/coto/${currentCotoId}/socios-con-perros`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        actualizarListaSocios(data.socios);
                        actualizarMarcadoresEnMapa(data.socios);
                        actualizarEstadisticas(data.totalSocios, data.totalPerros);
                        
                        document.getElementById('statusMessage').textContent = 
                            `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()} - ${data.totalSocios} socios, ${data.totalPerros} perros`;
                        document.getElementById('statusMessage').className = 'status-online';
                    }
                } catch (error) {
                    console.error('Error actualizando socios con perros:', error);
                    document.getElementById('statusMessage').textContent = 'Error de conexi√≥n';
                    document.getElementById('statusMessage').className = 'status-offline';
                }
            }

            function actualizarListaSocios(socios) {
                const listaDiv = document.getElementById('sociosList');
                
                if (socios.length === 0) {
                    listaDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No hay socios en el coto</div>';
                    return;
                }
                
                listaDiv.innerHTML = socios.map(socio => `
                    <div class="socio-item">
                        <div class="socio-name">${socio.nombre}</div>
                        <div class="socio-coords">üìç ${socio.lat.toFixed(5)}, ${socio.lng.toFixed(5)}</div>
                        
                        ${socio.perros && socio.perros.length > 0 ? `
                            <div style="margin-top: 8px; font-size: 0.85em;">
                                <strong>üêï Perros (${socio.perros.length}):</strong>
                                ${socio.perros.map(perro => `
                                    <div style="margin-left: 10px; margin-top: 4px; padding: 4px; background: #f8f9fa; border-radius: 4px;">
                                        <span style="color: #333;">${perro.nombre}</span> 
                                        (${perro.identificador})
                                        ${perro.tieneUbicacion ? 
                                            `<br><small style="color: #28a745;">üìç ${perro.pos_y.toFixed(5)}, ${perro.pos_x.toFixed(5)}</small>` : 
                                            `<br><small style="color: #999;">üìç Sin ubicaci√≥n</small>`
                                        }
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="margin-top: 8px; font-size: 0.85em; color: #999;">
                                Sin perros asignados
                            </div>
                        `}
                        
                        <div class="socio-status status-dentro">‚úÖ En el coto</div>
                    </div>
                `).join('');
            }

            function actualizarMarcadoresEnMapa(socios) {
                // Limpiar marcadores anteriores de socios
                Object.values(marcadoresSocios).forEach(marker => {
                    if (marker) window.adminMap.removeLayer(marker);
                });
                marcadoresSocios = {};
                
                // Limpiar marcadores anteriores de perros
                marcadoresPerrosAdmin.forEach(marker => {
                    if (marker) window.adminMap.removeLayer(marker);
                });
                marcadoresPerrosAdmin.clear();
                
                // Agregar nuevos marcadores
                socios.forEach(socio => {
                    // Marcador del socio
                    const marker = L.marker([socio.lat, socio.lng])
                        .bindPopup(generarPopupSocio(socio))
                        .addTo(window.adminMap);
                    
                    marcadoresSocios[socio.id] = marker;
                    
                    // Marcadores de perros de este socio (si tienen ubicaci√≥n)
                    if (socio.perros && socio.perros.length > 0) {
                        socio.perros.forEach(perro => {
                            if (perro.tieneUbicacion) {
                                agregarMarcadorPerro(perro, socio);
                            }
                        });
                    }
                });
            }

            // Nueva funci√≥n para generar popup con informaci√≥n de socios y perros
            function generarPopupSocio(socio) {
                let contenido = `
                    <b>üë§ ${socio.nombre}</b><br>
                    üìç En el coto<br>
                    ${socio.lat.toFixed(5)}, ${socio.lng.toFixed(5)}
                `;
                
                if (socio.perros && socio.perros.length > 0) {
                    contenido += `<br><br><b>üêï Perros (${socio.perros.length}):</b>`;
                    socio.perros.forEach(perro => {
                        contenido += `<br>‚Ä¢ ${perro.nombre} (${perro.identificador})`;
                        if (perro.tieneUbicacion) {
                            contenido += ` - üìç ${perro.pos_y.toFixed(5)}, ${perro.pos_x.toFixed(5)}`;
                        }
                    });
                }
                
                return contenido;
            }

            // Nueva funci√≥n para agregar marcadores de perros
            function agregarMarcadorPerro(perro, socio) {
                const perroIcon = L.divIcon({
                    className: 'perro-marcador',
                    html: `<div style="background: #ff6b35; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">üêï</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const marker = L.marker([perro.pos_y, perro.pos_x], { icon: perroIcon })
                    .bindPopup(`
                        <b>üêï ${perro.nombre}</b><br>
                        üÜî ${perro.identificador}<br>
                        üë§ Propietario: ${socio.nombre}<br>
                        üìç ${perro.pos_y.toFixed(5)}, ${perro.pos_x.toFixed(5)}
                    `)
                    .addTo(window.adminMap);
                
                marcadoresPerrosAdmin.set(`perro-${perro.id}`, marker);
            }

            function actualizarEstadisticas(totalSocios, totalPerros) {
                document.getElementById('totalSocios').textContent = totalSocios;
                document.getElementById('sociosEnCoto').textContent = totalSocios;
                
                // Actualizar o crear estad√≠stica de perros
                let perrosStat = document.getElementById('totalPerros');
                if (!perrosStat) {
                    const statsDiv = document.querySelector('.stats');
                    statsDiv.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-number" id="totalPerros">${totalPerros}</div>
                            <div class="stat-label">Perros</div>
                        </div>
                    `;
                } else {
                    perrosStat.textContent = totalPerros;
                }
            }

            function iniciarMonitoreo() {
                if (intervaloMonitoreo) {
                    clearInterval(intervaloMonitoreo);
                }
                
                intervaloMonitoreo = setInterval(async () => {
                    await actualizarSociosEnCoto();
                    // Tambi√©n cargar perros generales del coto
                    await cargarPerrosDelCoto();
                }, 5000);
                
                document.getElementById('btnIniciarMonitoreoAdmin').style.display = 'none';
                document.getElementById('btnDetenerMonitoreoAdmin').style.display = 'block';
                document.getElementById('statusMessage').textContent = 'Monitoreo activo - Cargando...';
                document.getElementById('statusMessage').className = 'status-online';
                
                // Primera actualizaci√≥n inmediata
                actualizarSociosEnCoto();
                cargarPerrosDelCoto();
            }

            function detenerMonitoreo() {
                if (intervaloMonitoreo) {
                    clearInterval(intervaloMonitoreo);
                    intervaloMonitoreo = null;
                }
                
                document.getElementById('btnIniciarMonitoreoAdmin').style.display = 'block';
                document.getElementById('btnDetenerMonitoreoAdmin').style.display = 'none';
                document.getElementById('statusMessage').textContent = 'Monitoreo detenido';
                document.getElementById('statusMessage').className = 'status-offline';
                
                // Limpiar marcadores de socios
                Object.values(marcadoresSocios).forEach(marker => {
                    if (marker) window.adminMap.removeLayer(marker);
                });
                marcadoresSocios = {};
                
                // Limpiar lista
                document.getElementById('sociosList').innerHTML = 
                    '<div style="text-align: center; color: #666; padding: 20px;">Monitoreo no activo</div>';
            }

            // Event listeners para admin de coto
            document.getElementById('btnIniciarMonitoreoAdmin').addEventListener('click', iniciarMonitoreo);
            document.getElementById('btnDetenerMonitoreoAdmin').addEventListener('click', detenerMonitoreo);

            let intervaloPerros = null;
            
            function iniciarMonitoreoPerros() {
                if (intervaloPerros) {
                    clearInterval(intervaloPerros);
                }
                
                // Actualizar perros cada 30 segundos (m√°s lento que socios)
                intervaloPerros = setInterval(cargarPerrosDelCoto, 30000);
            }
            
            function detenerMonitoreoPerros() {
                if (intervaloPerros) {
                    clearInterval(intervaloPerros);
                    intervaloPerros = null;
                }
            }
            
            // Iniciar monitoreo de perros cuando se inicia el monitoreo de socios
            const originalIniciarMonitoreo = iniciarMonitoreo;
            iniciarMonitoreo = function() {
                originalIniciarMonitoreo();
                iniciarMonitoreoPerros();
            };
            
            const originalDetenerMonitoreo = detenerMonitoreo;
            detenerMonitoreo = function() {
                originalDetenerMonitoreo();
                detenerMonitoreoPerros();
            };

            // Iniciar monitoreo autom√°ticamente
            iniciarMonitoreo();
        }
    </script>
</body>
</html>